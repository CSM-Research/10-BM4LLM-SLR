<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Study Decisions Table</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <div id="imports"></div>
  <script src="assets/templates.js"></script>
  <style>
    .table-responsive {
      max-height: 70vh;
      overflow-y: auto;
    }

    td.abstract-cell {
      max-width: 350px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s ease;
      background-color: white;
    }

    .drop-zone.dragover {
      border-color: #0d6efd;
      background-color: #f0f8ff;
    }

    .drop-zone input {
      display: none;
    }

    .file-name {
      font-size: 0.9rem;
      color: #555;
      margin-top: 5px;
    }
  </style>
</head>

<body class="bg-light">

    <div id="header"></div>

  <div class="container py-5">
    <h2 class="mb-4 text-center">Study Decisions Table</h2>

    <!-- Drag & Drop ZIP -->
    <div class="drop-zone" id="zipDropZone">
      Drag & Drop your ZIP containing included.json, excluded.json, metadata.json
      <input type="file" id="zipInput" accept=".zip" />
      <div class="file-name" id="fileNameZip"></div>
    </div>

    <div id="errorMsg" class="alert alert-danger d-none mt-3"></div>

    <div id="tableContainer" class="table-responsive d-none mt-3">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>Title</th>
            <th>Abstract</th>
            <th>Authors</th>
            <th>Year</th>
            <th>Decision</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="mt-3">
      <button class="btn btn-primary" id="downloadBibBtn" disabled>Download as .bib</button>
    </div>
  </div>

  <script>
    const zipZone = document.getElementById("zipDropZone");
    const zipInput = document.getElementById("zipInput");
    const fileNameDisplay = document.getElementById("fileNameZip");
    const errorMsg = document.getElementById("errorMsg");
    const tableContainer = document.getElementById("tableContainer");
    const tableBody = document.getElementById("tableBody");
    const downloadBibBtn = document.getElementById("downloadBibBtn");

    zipZone.addEventListener("click", () => zipInput.click());
    zipInput.addEventListener("change", () => { fileNameDisplay.textContent = zipInput.files[0]?.name || ""; processZip(); });
    zipZone.addEventListener("dragover", e => { e.preventDefault(); zipZone.classList.add("dragover"); });
    zipZone.addEventListener("dragleave", () => zipZone.classList.remove("dragover"));
    zipZone.addEventListener("drop", e => {
      e.preventDefault();
      zipZone.classList.remove("dragover");
      if (e.dataTransfer.files.length) {
        zipInput.files = e.dataTransfer.files;
        fileNameDisplay.textContent = zipInput.files[0].name;
        processZip();
      }
    });

    async function processZip() {
      errorMsg.classList.add("d-none");
      tableContainer.classList.add("d-none");
      tableBody.innerHTML = "";
      downloadBibBtn.disabled = true;

      if (!zipInput.files.length) return;

      try {
        const file = zipInput.files[0];
        const data = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(data);

        const includedJson = await zip.file("included.json")?.async("string").then(JSON.parse) || [];
        const excludedJson = await zip.file("excluded.json")?.async("string").then(JSON.parse) || [];
        const metadataJson = await zip.file("metadata.json")?.async("string").then(JSON.parse) || [];

        if (!includedJson.length && !excludedJson.length) throw new Error("No included.json or excluded.json found");

        const combinedData = [
          ...includedJson.map(item => ({ ...item, decision: "Include" })),
          ...excludedJson.map(item => ({ ...item, decision: "Exclude" }))
        ];

        combinedData.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.title || "—"}</td>
            <td class="abstract-cell" title="${item.abstract || ""}">${item.abstract || "—"}</td>
            <td>${item.author || "—"}</td>
            <td>${item.year || "—"}</td>
            <td>${item.decision}</td>
          `;
          tableBody.appendChild(tr);
        });

        tableContainer.classList.remove("d-none");
        window._combinedData = { metadata: metadataJson, data: combinedData };
        downloadBibBtn.disabled = false;

      } catch (err) {
        errorMsg.textContent = err.message || err;
        errorMsg.classList.remove("d-none");
      }
    }

    function jsonToBib(data) {
      return data.map(item => {
        const entryType = item.ENTRYTYPE || "article";
        const citeKey = item.ID || item.doi?.replace(/[^\w]/g, "_") || "unknown";
        const fields = {
          author: item.author,
          title: item.title,
          journal: item.journal,
          year: item.year,
          volume: item.volume,
          number: item.number,
          pages: item.pages,
          doi: item.doi,
          url: item.url,
          decision: item.decision
        };
        const fieldStrings = Object.entries(fields)
          .filter(([_, v]) => v)
          .map(([k, v]) => `  ${k} = {${v}}`)
          .join(",\n");
        return `@${entryType}{${citeKey},\n${fieldStrings}\n}`;
      }).join("\n\n");
    }

    downloadBibBtn.addEventListener("click", () => {
      if (!window._combinedData) return;
      const bibText = jsonToBib(window._combinedData.data);
      const blob = new Blob([bibText], { type: "application/x-bibtex" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "combined_decisions.bib";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>

<script>
  $("#imports").load("components/imports.html");
  $("#header").load("components/header.html");
</script>


</html>