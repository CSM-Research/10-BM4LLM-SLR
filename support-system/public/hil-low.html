<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Step 4 – LLM Re-Evaluation (Low Confidence)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body class="bg-light" style="height: 100vh;">

  <!-- Sidebar Offcanvas -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarLabel"><a style="text-decoration: none; color: white;"
          href="login-management.html"> BM4LLM-SLR </a></h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item text-white-50 fw-bold mt-2">Welcome</li>
        <li class="nav-item"><a class="nav-link text-white" href="index.html">Introduction</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="instructions.html">Instructions</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Configuration</li>
        <li class="nav-item"><a class="nav-link text-white" href="questionnaire.html">Participant Profile</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="preferences.html">Run Setup</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Pre-Selection Phase</li>
        <li class="nav-item"><a class="nav-link text-white" href="experimentation.html">LLM-Assisted Review</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Looping Phase</li>
        <li class="nav-item"><a class="nav-link text-white" href="hil-confidence.html">Start Looping</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Results</li>
        <li class="nav-item"><a class="nav-link text-white active" href="finalReport.html">Final Report</a></li>
      </ul>
    </div>
  </div>

  <!-- Top Navbar -->
  <nav class="navbar bg-dark text-white">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar"
        aria-controls="sidebar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="navbar-brand mb-0 h1 text-white"><a style="text-decoration: none; color: white;"
          href="login-management.html"> BM4LLM-SLR </a></span>
    </div>
  </nav>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-12 bg-white p-4 rounded shadow-sm">
        <h2 class="mb-4 text-center">Low Confidence Re-Evaluation</h2>
        <div id="cardsContainer"></div>
        <button class="btn btn-success save-btn mt-4">Save and Continue</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const templates = {
      felizardo: (title, abstract, keywords, criteria) => `
Assume you are a software engineering researcher conducting a systematic literature review (SLR).
Title: ${title}
Abstract: ${abstract}
Keywords: ${keywords}
Using a 1-7 Likert scale (1 - Strongly disagree, ..., 7 - Strongly agree), rate your agreement with the following criteria (only number). Remember if it is not possible to evaluate based on the provided information give the score -1.
${localStorage.getItem("fullCriteria")}
Return the result in CSV format with columns: Criteria, Rate\n
Do not give me the file, give me in chat in csv format`.trim()
    };

    async function loadRunData() {
      const runId = localStorage.getItem("runId");
      const res = await fetch(`/get-run/${runId}`);
      if (!res.ok) {
        alert("Failed to load run data.");
        return null;
      }
      return res.json();
    }

    function generatePrompt(template, study, criteria) {
      return templates[template]?.(study.Title, study.Abstract, study.Keywords || '', criteria) || 'Prompt unavailable.';
    }

    async function loadAndRender() {
      const raw = localStorage.getItem("excludedStudies");
      if (!raw) {
        alert("No excluded studies found.");
        return;
      }

      excludedStudies = JSON.parse(raw);
      const run = await loadRunData();
      const promptType = run?.prompt || 'felizardo';
      const criteria = run?.criteria || 'Insert your inclusion/exclusion criteria here';

      const model2Name = localStorage.getItem('model2') || 'Model 2';
      const model3Name = localStorage.getItem('model3') || 'Model 3';

      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      excludedStudies.forEach((study, idx) => {
        const prompt = generatePrompt(promptType, study, criteria);
        const card = document.createElement("div");
        card.className = "card mb-4";
        card.setAttribute("data-idx", idx);
        card.innerHTML = `
      <div class="card-body">
        <h5 class="card-title">${study.Title}</h5>
        <p><strong>Abstract:</strong> ${study.Abstract}</p>
        <p><strong>Keywords:</strong> ${study.Keywords || "—"}</p>

        <div class="accordion mb-3" id="promptAccordion${idx}">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapsePrompt${idx}" aria-expanded="false" aria-controls="collapsePrompt${idx}">
                Show Prompt
              </button>
            </h2>
            <div id="collapsePrompt${idx}" class="accordion-collapse collapse">
              <div class="accordion-body">
                <pre id="promptText${idx}" class="bg-light p-3 rounded" style="white-space: pre-wrap;">${prompt}</pre>
                <button class="btn btn-sm btn-primary mt-2 copy-btn" data-target="promptText${idx}">Copy</button>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Paste the response from ${model2Name}:</label>
          <textarea class="form-control output-box-1" rows="4" placeholder="Paste the result here..."></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Paste the response from ${model3Name}:</label>
          <textarea class="form-control output-box-2" rows="4" placeholder="Paste the result here..."></textarea>
        </div>
      </div>`;
        container.appendChild(card);
      });

      bindSaveEvents();
    }

    function parseCSVToJSON(csvText) {
      const lines = csvText.trim().split("\n");
      const result = {};
      for (let i = 1; i < lines.length; i++) {
        const [key, value] = lines[i].split(",").map(s => s.trim());
        if (!key || isNaN(value)) throw new Error("Invalid CSV format.");
        result[key] = parseInt(value, 10);
      }
      return result;
    }

    function bindSaveEvents() {
      document.querySelector(".save-btn").addEventListener("click", () => {
        const cards = document.querySelectorAll(".card");

        for (let i = 0; i < cards.length; i++) {
          const card = cards[i];
          const output1 = card.querySelector(".output-box-1").value.trim();
          const output2 = card.querySelector(".output-box-2").value.trim();

          if (!output1 || !output2) {
            alert(`Missing output(s) for study ${i + 1}.`);
            return;
          }

          try {
            const parsed1 = parseCSVToJSON(output1);
            const parsed2 = parseCSVToJSON(output2);
            excludedStudies[i].secondModelOpinion = parsed1;
            excludedStudies[i].thirdModelOpinion = parsed2;
          } catch (e) {
            alert(`Error parsing CSV for study ${i + 1}: ${e.message}`);
            return;
          }
        }

        // Salvar novamente os dados em localStorage
        localStorage.setItem("excludedStudies", JSON.stringify(excludedStudies));

        // Salvar opiniões separadamente (útil para consensus.html)
        const firstModel = excludedStudies.map(s => s.firstModelOpinion || {});
        const secondModel = excludedStudies.map(s => s.secondModelOpinion || {});
        const thirdModel = excludedStudies.map(s => s.thirdModelOpinion || {});

        localStorage.setItem("firstModelOpinion", JSON.stringify(firstModel));
        localStorage.setItem("secondModelOpinion", JSON.stringify(secondModel));
        localStorage.setItem("thirdModelOpinion", JSON.stringify(thirdModel));

        window.location.href = "auto-consensus.html";
      });
    }

    // Evento global para copiar texto dos prompts
    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('copy-btn')) {
        const targetId = event.target.getAttribute('data-target');
        const textToCopy = document.getElementById(targetId).innerText;

        navigator.clipboard.writeText(textToCopy).then(() => {
          const originalText = event.target.innerText;
          event.target.innerText = 'Copied!';
          setTimeout(() => {
            event.target.innerText = originalText;
          }, 2000);
        }).catch(() => {
          alert('Failed to copy text.');
        });
      }
    });

    window.addEventListener("DOMContentLoaded", loadAndRender);
  </script>
</body>

</html>
