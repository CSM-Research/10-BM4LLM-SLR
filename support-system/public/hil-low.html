<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Step 4 – LLM Re-Evaluation (Low Confidence)</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <div id="imports"></div>
</head>

<body class="bg-light" style="height: 100vh;">
  <div id="header"></div>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-12 bg-white p-4 rounded shadow-sm">
        <h2 class="mb-4 text-center">Low Confidence Re-Evaluation</h2>
        <div id="cardsContainer"></div>
        <button class="btn btn-success save-btn mt-4">Save and Continue</button>
      </div>
    </div>
  </div>


  <script>

    async function loadRunData() {
      const runId = localStorage.getItem("runId");
      const res = await fetch(`/get-run/${runId}`);
      if (!res.ok) {
        alert("Failed to load run data.");
        return null;
      }
      return res.json();
    }

    function generatePrompt(template, study, criteria) {
      return templates[template]?.(
        study.Title,
        study.Abstract,
        study.Keywords || '',
        study["Publication venue"] || '',
        study["Publication date"] || '',
        criteria
      ) || 'Prompt unavailable.';
    }

    async function loadAndRender() {
      const raw = localStorage.getItem("excludedStudies");
      if (!raw) {
        alert("No excluded studies found.");
        return;
      }

      excludedStudies = JSON.parse(raw);
      const run = await loadRunData();
      const promptType = run?.prompt || 'felizardo';
      const criteria = localStorage.getItem("fullCriteria") || 'Insert your inclusion/exclusion criteria here';

      const model2Name = localStorage.getItem('model2') || 'Model 2';
      const model3Name = localStorage.getItem('model3') || 'Model 3';

      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      excludedStudies.forEach((study, idx) => {
        const prompt = generatePrompt(promptType, study, criteria);
        const card = document.createElement("div");
        card.className = "card mb-4";
        card.setAttribute("data-idx", idx);
        card.innerHTML = `
      <div class="card-body">
        <h5 class="card-title">${study.Title}</h5>
        <p><strong>Abstract:</strong> ${study.Abstract}</p>
        <p><strong>Keywords:</strong> ${study.Keywords || "—"}</p>

        <div class="accordion mb-3" id="promptAccordion${idx}">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapsePrompt${idx}" aria-expanded="false" aria-controls="collapsePrompt${idx}">
                Show Prompt
              </button>
            </h2>
            <div id="collapsePrompt${idx}" class="accordion-collapse collapse">
              <div class="accordion-body">
                <pre id="promptText${idx}" class="bg-light p-3 rounded" style="white-space: pre-wrap;">${prompt}</pre>
                <button class="btn btn-sm btn-primary mt-2 copy-btn" data-target="promptText${idx}">Copy</button>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Paste the response from ${model2Name}:</label>
          <textarea class="form-control output-box-1" rows="4" placeholder="Paste the result here..."></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Paste the response from ${model3Name}:</label>
          <textarea class="form-control output-box-2" rows="4" placeholder="Paste the result here..."></textarea>
        </div>
      </div>`;
        container.appendChild(card);
      });

      bindSaveEvents();
    }

    function parseCSVToJSON(csvText) {
      const lines = csvText.trim().split("\n");
      const result = {};
      for (let i = 1; i < lines.length; i++) {
        const [key, value] = lines[i].split(",").map(s => s.trim());
        if (!key || isNaN(value)) throw new Error("Invalid CSV format.");
        result[key] = parseInt(value, 10);
      }
      return result;
    }

    function bindSaveEvents() {
      document.querySelector(".save-btn").addEventListener("click", () => {
        const cards = document.querySelectorAll(".card");

        for (let i = 0; i < cards.length; i++) {
          const card = cards[i];
          const output1 = card.querySelector(".output-box-1").value.trim();
          const output2 = card.querySelector(".output-box-2").value.trim();

          if (!output1 || !output2) {
            alert(`Missing output(s) for study ${i + 1}.`);
            return;
          }

          try {
            const parsed1 = parseCSVToJSON(output1);
            const parsed2 = parseCSVToJSON(output2);
            excludedStudies[i].secondModelOpinion = parsed1;
            excludedStudies[i].thirdModelOpinion = parsed2;
          } catch (e) {
            alert(`Error parsing CSV for study ${i + 1}: ${e.message}`);
            return;
          }
        }

        // Salvar novamente os dados em localStorage
        localStorage.setItem("excludedStudies", JSON.stringify(excludedStudies));

        // Salvar opiniões separadamente (útil para consensus.html)
        const firstModel = excludedStudies.map(s => s.firstModelOpinion || {});
        const secondModel = excludedStudies.map(s => s.secondModelOpinion || {});
        const thirdModel = excludedStudies.map(s => s.thirdModelOpinion || {});

        localStorage.setItem("firstModelOpinion", JSON.stringify(firstModel));
        localStorage.setItem("secondModelOpinion", JSON.stringify(secondModel));
        localStorage.setItem("thirdModelOpinion", JSON.stringify(thirdModel));

        window.location.href = "auto-consensus.html";
      });
    }

    // Evento global para copiar texto dos prompts
    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('copy-btn')) {
        const targetId = event.target.getAttribute('data-target');
        const textToCopy = document.getElementById(targetId).innerText;

        navigator.clipboard.writeText(textToCopy).then(() => {
          const originalText = event.target.innerText;
          event.target.innerText = 'Copied!';
          setTimeout(() => {
            event.target.innerText = originalText;
          }, 2000);
        }).catch(() => {
          alert('Failed to copy text.');
        });
      }
    });

    window.addEventListener("DOMContentLoaded", loadAndRender);
  </script>
</body>

<script>
  $("#imports").load("components/imports.html");
  $("#header").load("components/header.html");
</script>

</html>