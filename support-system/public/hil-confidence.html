<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Step 4 - Human-in-the-Loop Confidence</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .confidence-btn {
      width: 100%;
      font-size: 1.25rem;
      padding: 1rem;
    }

    .btn-high {
      background-color: #198754;
      color: white;
    }

    .btn-high:hover {
      background-color: #146c43;
      color: white;
    }

    .btn-low {
      background-color: #0d6efd;
      color: white;
    }

    .btn-low:hover {
      background-color: #0a58ca;
      color: white;
    }

    .explanation {
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }

    .upload-section {
      margin-top: 2rem;
    }

    /* Drag and drop styles */
    .dropzone {
      border: 2px dashed #0d6efd;
      border-radius: 0.375rem;
      padding: 2rem;
      text-align: center;
      color: #0d6efd;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }

    .dropzone.dragover {
      background-color: #e9f0ff;
      border-color: #0a58ca;
      color: #0a58ca;
    }

    .dropzone input[type="file"] {
      display: none;
    }
  </style>
</head>

<body class="bg-light" style="height: 100vh;">

  <!-- Sidebar Offcanvas -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarLabel"><a style="text-decoration: none; color: white;" href="login-management.html"> BM4LLM-SLR </a></h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">


        
        

        <li class="nav-item text-white-50 fw-bold mt-4">Configuration</li>
        <li class="nav-item"><a class="nav-link text-white" href="questionnaire.html">Participant Profile</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="preferences.html">Run Setup</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Pre-Selection Phase</li>
        <li class="nav-item"><a class="nav-link text-white" href="experimentation.html">LLM-Assisted Review</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Looping Phase</li>
        <li class="nav-item"><a class="nav-link text-white" href="hil-confidence.html">Start Looping</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Results</li>
        <li class="nav-item"><a class="nav-link text-white" href="finalReport.html">Final Report</a></li>

      </ul>
    </div>
  </div>

  <!-- Top Navbar (for toggle button) -->
  <nav class="navbar bg-dark text-white">
    <div class="container-fluid">
      <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar"
        aria-controls="sidebar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="navbar-brand mb-0 h1 text-white"><a style="text-decoration: none; color: white;" href="login-management.html"> BM4LLM-SLR </a></span>
    </div>
  </nav>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10 bg-white p-5 rounded shadow-sm">

        <!-- Title -->
        <h2 class="mb-4 text-center">Start Looping</h2>

        <!-- Explanation -->
        <div class="explanation">
          <p>Until now, only the automatic selection has been performed. The confidence threshold has been set and
            allows including or excluding studies based on the criteria scores.</p>
          <p>Now, we will begin the <strong>Human-in-the-Loop (HIL)</strong> phase. This phase requires you to choose a
            confidence level for screening studies:</p>
          <ul>
            <li><strong>Low confidence</strong>: uses the opinion of another large language model (LLM) for selection.
              This option is recommended only for pilot tests.</li>
            <li><strong>High confidence</strong>: is recommended for the final set of studies, as it involves a careful
              human review.</li>
          </ul>
          <p>Please select the confidence level you wish to proceed with:</p>
        </div>
        <!-- Confidence Buttons -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <button id="btn-low" class="btn confidence-btn btn-low">Low Confidence</button>
          </div>
          <div class="col-md-6">
            <button id="btn-high" class="btn confidence-btn btn-high">High Confidence</button>
          </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
          <h5>Upload Output Assets ZIP</h5>
          <p class="text-muted">Please upload the ZIP file containing the output JSON files (metadata.json, included.json, excluded.json, fullRunStudies.json). The data
            will be extracted and saved locally for the next steps.</p>

          <label for="uploadZip" class="dropzone" id="dropzone">
            Drag & Drop your ZIP file here, or click to select
            <input type="file" id="uploadZip" accept=".zip" />
          </label>

          <div id="uploadStatus" class="text-success mt-3" style="display: none;">✅ File successfully loaded and saved.</div>
          <div id="uploadError" class="text-danger mt-3" style="display: none;"></div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script>
    document.getElementById('btn-low').addEventListener('click', () => {
      localStorage.setItem('hilConfidenceLevel', 'low');
      alert('You selected Low Confidence (recommended for pilot tests). Proceeding...');
      window.location.href = 'hil-low.html';
    });

    document.getElementById('btn-high').addEventListener('click', () => {
      localStorage.setItem('hilConfidenceLevel', 'high');
      window.location.href = 'hil-high.html';
    });

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('uploadZip');
    const status = document.getElementById('uploadStatus');
    const error = document.getElementById('uploadError');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    // Highlight drop area when file is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => {
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => {
        dropzone.classList.remove('dragover');
      });
    });

    // Handle dropped files
    dropzone.addEventListener('drop', (e) => {
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFile(fileInput.files[0]);
      }
    });

    // Handle click to open file dialog
    dropzone.addEventListener('click', () => fileInput.click());

    // Handle file input change
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) {
        handleFile(fileInput.files[0]);
      }
    });

    function handleFile(file) {
      status.style.display = 'none';
      error.style.display = 'none';
      error.textContent = '';

      if (!file.name.toLowerCase().endsWith('.zip')) {
        error.style.display = 'block';
        error.textContent = '❌ Please upload a valid ZIP file.';
        return;
      }

      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const zip = await JSZip.loadAsync(e.target.result);

          // Define the expected files and their storage keys
          const expectedFiles = {
            'metadata.json': 'metadata',
            'included.json': 'includedStudies',
            'excluded.json': 'excludedStudies',
            'fullRunStudies.json': 'fullRunStudies'
          };

          let loadedFilesCount = 0;

          for (const [filename, storageKey] of Object.entries(expectedFiles)) {
            if (zip.file(filename)) {
              const content = await zip.file(filename).async("string");
              // Validate JSON parse
              try {
                JSON.parse(content);
                localStorage.setItem(storageKey, content);
                loadedFilesCount++;
              } catch {
                error.style.display = 'block';
                error.textContent = `❌ ${filename} is not a valid JSON file.`;
                return;
              }
            } else {
              console.warn(`${filename} not found in ZIP.`);
            }
          }

          if (loadedFilesCount > 0) {
            status.style.display = 'block';
            status.textContent = `✅ Loaded ${loadedFilesCount} file(s) successfully and saved to localStorage.`;
          } else {
            error.style.display = 'block';
            error.textContent = '❌ No valid JSON files found in the ZIP.';
          }
        } catch (err) {
          console.error('Error reading ZIP file', err);
          error.style.display = 'block';
          error.textContent = '❌ Failed to read ZIP file. Please try again.';
        }
      };
      reader.readAsArrayBuffer(file);
    }
  </script>

</body>

</html>
