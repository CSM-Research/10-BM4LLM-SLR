<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Step 3 - Output Review</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .card.included {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .card.excluded {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    label {
      font-weight: 600;
      margin-top: 0.5rem;
      display: block;
    }

    input[type="number"] {
      max-width: 80px;
    }

    .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    }
  </style>
</head>

<body class="bg-light">

  <!-- Sidebar Offcanvas -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarLabel"><a style="text-decoration: none; color: white;"
          href="login-management.html"> BM4LLM-SLR </a></h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item text-white-50 fw-bold mt-2">Welcome</li>
        <li class="nav-item"><a class="nav-link text-white" href="index.html">Introduction</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="instructions.html">Instructions</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Configuration</li>
        <li class="nav-item"><a class="nav-link text-white" href="questionnaire.html">Participant Profile</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="preferences.html">Run Setup</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Pre-Selection Phase</li>
        <li class="nav-item"><a class="nav-link text-white" href="experimentation.html">LLM-Assisted Review</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Looping Phase</li>
        <li class="nav-item"><a class="nav-link text-white" href="hil-confidence.html">Start Looping</a></li>

        <li class="nav-item text-white-50 fw-bold mt-4">Results</li>
        <li class="nav-item"><a class="nav-link text-white active" href="finalReport.html">Final Report</a></li>
      </ul>
    </div>
  </div>

  <!-- Top Navbar -->
  <nav class="navbar bg-dark text-white">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar"
        aria-controls="sidebar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="navbar-brand mb-0 h1 text-white"><a style="text-decoration: none; color: white;"
          href="login-management.html"> BM4LLM-SLR </a></span>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10 bg-white p-5 rounded shadow-sm">

        <h2 class="mb-4 text-center">Output Review</h2>

        <!-- Confidence Settings -->
        <div class="card mb-4 p-3">
          <h4 class="card-title mb-3">Confidence Level Settings</h4>
          <form id="confidence-form" class="row row-cols-1 row-cols-md-2 g-3">

            <div class="col">
              <h5>Inclusion Criteria</h5>
              <div class="mb-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="inclusion-mode" id="inc-all" value="all" checked>
                  <label class="form-check-label" for="inc-all">Match All</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="inclusion-mode" id="inc-one" value="one">
                  <label class="form-check-label" for="inc-one">Match One</label>
                </div>
              </div>
              <div id="inclusion-fields"></div>
            </div>

            <div class="col">
              <h5>Exclusion Criteria</h5>
              <div class="mb-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="exclusion-mode" id="exc-all" value="all" checked>
                  <label class="form-check-label" for="exc-all">Match All</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="exclusion-mode" id="exc-one" value="one">
                  <label class="form-check-label" for="exc-one">Match One</label>
                </div>
              </div>
              <div id="exclusion-fields"></div>
            </div>

          </form>
        </div>

        <!-- Summary -->
        <div id="summary" class="alert alert-info mb-4">Loading...</div>

        <!-- Studies Display -->
        <div id="studies" class="row g-4"></div>

        <!-- Actions -->
        <div class="my-4 text-end">
          <button id="download-btn" class="btn btn-success">Download Assets</button>
          <a class="btn btn-primary" href="hil-confidence.html">Continue...</a>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let allData = [];

    function getConfidenceConfig() {
      const config = {};
      document.querySelectorAll('#confidence-form input[type=number]').forEach(input => {
        config[input.name] = parseInt(input.value, 10);
      });
      return config;
    }

    function getMatchMode() {
      const inclusionMode = document.querySelector('input[name="inclusion-mode"]:checked')?.value || 'all';
      const exclusionMode = document.querySelector('input[name="exclusion-mode"]:checked')?.value || 'all';
      return { inclusionMode, exclusionMode };
    }




    function passesCriteria(output, config) {
      const { inclusionMode, exclusionMode } = getMatchMode();
      const inclusionCriteria = Object.keys(config).filter(k => k.startsWith('IC'));
      const exclusionCriteria = Object.keys(config).filter(k => k.startsWith('EC'));

      // Filtra critérios de inclusão que não têm valor -1
      const validInclusionCriteria = inclusionCriteria.filter(c => output[c] !== -1 && output[c] !== undefined);
      // Filtra critérios de exclusão que não têm valor -1
      const validExclusionCriteria = exclusionCriteria.filter(c => output[c] !== -1 && output[c] !== undefined);

      // Inclusão
      let inclusionPass = false;
      if (validInclusionCriteria.length === 0) {
        inclusionPass = true; // Sem critérios válidos de inclusão, passa automaticamente
      } else if (inclusionMode === 'all') {
        inclusionPass = validInclusionCriteria.every(c => output[c] >= config[c]);
      } else if (inclusionMode === 'one') {
        inclusionPass = validInclusionCriteria.some(c => output[c] >= config[c]);
      }

      // Exclusão
      let exclusionPass = false;
      if (validExclusionCriteria.length === 0) {
        exclusionPass = true; // Sem critérios válidos de exclusão, não passa exclusão
      } else if (exclusionMode === 'all') {
        exclusionPass = validExclusionCriteria.every(c => output[c] <= config[c]);
      } else if (exclusionMode === 'one') {
        exclusionPass = validExclusionCriteria.some(c => output[c] <= config[c]);
      }
      // Estudo será incluído apenas se passar na inclusão e NÃO passar na exclusão

      return inclusionPass && exclusionPass;
    }




    function updateDisplay() {
      const config = getConfidenceConfig();
      const container = document.getElementById('studies');
      container.innerHTML = '';

      let included = 0, excluded = 0;

      allData.forEach(study => {
        const isIncluded = passesCriteria(study.firstModelDecision, config);
        if (isIncluded) included++; else excluded++;

        const card = document.createElement('div');
        card.className = `col-12 card p-3 ${isIncluded ? 'included' : 'excluded'}`;
        card.innerHTML = `
          <h5>${study.Title}</h5>
          <p><strong>Authors:</strong> ${study.Authors}</p>
          <p><strong>Abstract:</strong> ${study.Abstract}</p>
          <p><strong>Keywords:</strong> ${study.Keywords}</p>
          <p><strong>Publication venue:</strong> ${study["Publication venue"]}</p>
          <p><strong>Publication date:</strong> ${study["Publication date"]}</p>
          <p><strong>Model Decision:</strong> ${JSON.stringify(study.firstModelDecision)}</p>
        `;
        container.appendChild(card);
      });

      document.getElementById('summary').innerText = `Included: ${included} | Excluded: ${excluded}`;
    }

    function generateDynamicCriteriaForm(allCriteriaKeys) {
      const inclusionContainer = document.getElementById('inclusion-fields');
      const exclusionContainer = document.getElementById('exclusion-fields');

      inclusionContainer.innerHTML = '';
      exclusionContainer.innerHTML = '';

      allCriteriaKeys.forEach(key => {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.name = key;
        input.id = key;
        input.min = 1;
        input.max = 7;
        input.value = key.startsWith('IC') ? 4 : 2;

        const label = document.createElement('label');
        label.htmlFor = key;
        label.innerText = key;

        const container = key.startsWith('IC') ? inclusionContainer : exclusionContainer;
        container.appendChild(label);
        container.appendChild(input);
      });

      document.querySelectorAll('#confidence-form input[type=number]').forEach(input => {
        input.addEventListener('input', updateDisplay);
      });
    }

    document.getElementById('download-btn').addEventListener('click', () => {
      const config = getConfidenceConfig();

      const fullRunRaw = localStorage.getItem('experimentAnswers');
      let fullRunStudies = [];
      if (fullRunRaw) {
        try {
          fullRunStudies = JSON.parse(fullRunRaw);
        } catch (e) {
          console.error('Error parsing fullRunStudies:', e);
        }
      }

      const includedStudies = [];
      const excludedStudies = [];

      allData.forEach(study => {
        const included = passesCriteria(study.firstModelDecision, config);

        if (included) {
          const studyWithDecision = { ...study, userDecision: "Include" };
          includedStudies.push(studyWithDecision);
        } else {
          excludedStudies.push(study);
        }
      });

      const zip = new JSZip();

      let fullCriteria = {};
      try {
        fullCriteria = JSON.parse(localStorage.getItem("fullCriteria"));
      } catch (e) {
        console.warn("Error parsing fullCriteria from localStorage:", e);
      }

      const metadata = {
        config,
        fullcriteria: fullCriteria
      };

      zip.file("metadata.json", JSON.stringify(metadata, null, 2));
      zip.file("included.json", JSON.stringify(includedStudies, null, 2));
      zip.file("excluded.json", JSON.stringify(excludedStudies, null, 2));
      zip.file("fullRunStudies.json", JSON.stringify(fullRunStudies, null, 2));

      zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "output-assets.zip";
        a.click();
        URL.revokeObjectURL(a.href);
      });
    });

    document.querySelectorAll('input[name="inclusion-mode"], input[name="exclusion-mode"]').forEach(radio => {
      radio.addEventListener('change', updateDisplay);
    });

    window.addEventListener('DOMContentLoaded', () => {
      try {
        const raw = localStorage.getItem('experimentAnswers');
        if (!raw) {
          document.getElementById('summary').innerText = "Nenhum dado salvo encontrado.";
          return;
        }

        allData = JSON.parse(raw);

        const firstDecision = allData[0]?.firstModelDecision || {};
        const allCriteria = Object.keys(firstDecision);
        generateDynamicCriteriaForm(allCriteria);

        updateDisplay();
      } catch (err) {
        console.error("Erro ao carregar dados do localStorage:", err);
        document.getElementById('summary').innerText = "Erro ao carregar dados.";
      }
    });
  </script>
</body>

</html>