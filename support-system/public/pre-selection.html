<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Phase 01 - Pre-selection</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/templates.js"></script>
</head>

<body class="bg-light" style="height: 100vh;">

  <div id="header"></div>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-12 bg-white p-4 rounded shadow-sm">
        <h2 class="mb-4 text-center">Pre-selection</h2>

        <div id="cardsContainer"></div>
        <button class="btn btn-success save-btn mt-4">Save Responses</button>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // Utility functions
    // ============================
    function shuffleArray(array) {
      return array.map(a => [Math.random(), a])
        .sort((a, b) => a[0] - b[0])
        .map(a => a[1]);
    }

    function buildCriteriaText(inclusion, exclusion) {
      const inc = inclusion.map(c => `- IC: ${c}`);
      const exc = exclusion.map(c => `- EC: ${c}`);
      return [...inc, ...exc].join("\n");
    }

    function generatePromptWithCriteria(type, study, criteriaText) {
      const title = study.title;
      const abstract = study.abstract;
      const keywords = study.keywords || "";
      const publication = study.journal || study.source || "—";
      const date = study.year || "—";

      switch (type) {
        case "felizardo":
          return templates.felizardo(title, abstract, keywords, publication, date, criteriaText);
        case "huotala":
          return templates.huotala(title, abstract, keywords, publication, date, criteriaText, "");
        case "thode":
          return templates.thode(title, abstract, keywords, publication, date, criteriaText);
        default:
          return "Prompt template not found.";
      }
    }

    function bindSaveEvents() {
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const cards = document.querySelectorAll('.card');
          const email = localStorage.getItem('participantEmail');
          if (!email) { alert("E-mail do participante não definido."); return; }

          for (let i = 0; i < cards.length; i++) {
            const card = cards[i];
            const outputText = card.querySelector('.output-box').value.trim();
            if (!outputText) { alert(`Estudo ${i + 1}: falta colar a resposta do modelo.`); return; }
            selectedStudiesData[i].firstModelDecision = outputText;
          }

          localStorage.setItem('experimentAnswers', JSON.stringify(selectedStudiesData));
          window.location.href = 'review.html';
        });
      });
    }

    // ============================
    // Load JSON studies from localStorage and display them
    // ============================
    const template = "felizardo";
    let selectedStudiesData = [];

    async function loadDataset() {
      try {
        const studiesJSON = localStorage.getItem("uploadedJsonFile");
        if (!studiesJSON) { alert("Nenhum arquivo JSON encontrado no localStorage."); return; }
        let studies = JSON.parse(studiesJSON);

        const selectedStudies = studies;
        selectedStudiesData = selectedStudies;

        // Critérios de inclusão/exclusão
        const savedData = JSON.parse(localStorage.getItem("preferencesData")) || {};
        const inclusionCriteria = savedData.inclusionCriteria || [];
        const exclusionCriteria = savedData.exclusionCriteria || [];
        const criteriaText = buildCriteriaText(inclusionCriteria, exclusionCriteria);

        const container = document.getElementById('cardsContainer');
        container.innerHTML = "";

        selectedStudies.forEach((study, idx) => {
          const prompt = generatePromptWithCriteria(template, study, criteriaText);
          const card = document.createElement('div');
          card.className = "card mb-4 w-100";
          card.setAttribute("data-study", JSON.stringify(study));

          card.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">${idx + 1}. ${study.title || "—"}</h5>
              <p><strong>Authors:</strong> ${study.author || "—"}</p>
              <p><strong>Abstract:</strong> ${study.abstract || "—"}</p>
              <p><strong>Journal/Conference:</strong> ${study.journal || study.source || "—"}</p>
              <p><strong>Year:</strong> ${study.year || "—"}</p>
              <p><strong>DOI:</strong> <a href="${study.doi ? 'https://doi.org/' + study.doi : '#'}" target="_blank">${study.doi || "—"}</a></p>
              <p><strong>URL:</strong> <a href="${study.url || '#'}" target="_blank">${study.url || "—"}</a></p>

              <div class="accordion mb-3" id="promptAccordion${idx}">
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                      data-bs-target="#collapsePrompt${idx}" aria-expanded="false" aria-controls="collapsePrompt${idx}">
                      Show Prompt
                    </button>
                  </h2>
                  <div id="collapsePrompt${idx}" class="accordion-collapse collapse" data-bs-parent="#promptAccordion${idx}">
                    <div class="accordion-body">
                      <pre id="promptText${idx}" class="bg-light p-3 rounded" style="white-space: pre-wrap;">${prompt}</pre>
                      <button class="btn btn-sm btn-primary mt-2 copy-btn" data-target="promptText${idx}">Copy</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Paste the response of ${savedData.model1 || "the model"} here:</label>
                <textarea class="form-control output-box" rows="4" placeholder="Paste the result here..."></textarea>
              </div>
            </div>
          `;

          container.appendChild(card);
        });

        bindSaveEvents();

      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        alert("Erro inesperado ao carregar dados.");
      }
    }

    // ============================
    // Clipboard copy
    // ============================
    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('copy-btn')) {
        const targetId = event.target.getAttribute('data-target');
        const textToCopy = document.getElementById(targetId).innerText;

        navigator.clipboard.writeText(textToCopy).then(() => {
          event.target.innerText = 'Copied!';
          setTimeout(() => { event.target.innerText = 'Copy'; }, 2000);
        }).catch(() => { alert('Failed to copy text.'); });
      }
    });

    // ============================
    // Initial load
    // ============================
    window.addEventListener("DOMContentLoaded", () => {
      $("#header").load("components/header.html");
      loadDataset();
    });

  </script>

</body>
</html>
